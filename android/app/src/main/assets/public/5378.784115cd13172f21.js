"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5378],{5378:(x,y,m)=>{m.r(y),m.d(y,{Tab2PageModule:()=>$});var g=m(4742),f=m(177),_=m(9417),p=m(7500),v=m(467),b=m(7468),t=m(4438),T=m(2064),D=m(7291),F=m(8150),I=m(8035);function C(i,d){1&i&&(t.j41(0,"div",9)(1,"p"),t.EFF(2,"Nenhum conte\xfado encontrado."),t.k0s()())}function P(i,d){if(1&i){const c=t.RV6();t.j41(0,"ion-item",2),t.bIt("click",function(){const o=t.eBV(c).$implicit,s=t.XpG().$implicit,e=t.XpG().$implicit,a=t.XpG();return t.Njj(a.openContentRecordForm(e.date,s.id,o.discipline_id,o.classroom_id,o.grade_id,o.description,o.classroom_name,s.name))}),t.j41(1,"p"),t.EFF(2),t.k0s(),t.j41(3,"ion-badge",1),t.EFF(4),t.k0s()()}if(2&i){const c=d.$implicit;t.R7$(2),t.Lme("",c.description," - ",c.classroom_name,""),t.R7$(2),t.Lme(" ",c.contents.length,"/",c.uniqueContents.length," ")}}function R(i,d){if(1&i){const c=t.RV6();t.j41(0,"ion-accordion",12)(1,"ion-item",13)(2,"ion-label"),t.EFF(3),t.k0s()(),t.j41(4,"div",14)(5,"ion-item")(6,"ion-button",15),t.bIt("click",function(){const o=t.eBV(c).$implicit,s=t.XpG().$implicit,e=t.XpG();return t.Njj(e.newContentRecordForm(s.date,o.id))}),t.nrm(7,"ion-icon",16),t.EFF(8," Adicionar novo conte\xfado "),t.k0s()(),t.DNE(9,P,5,4,"ion-item",17),t.k0s()()}if(2&i){const c=d.$implicit;t.R7$(3),t.JRh(c.name),t.R7$(6),t.Y8G("ngForOf",c.unityItems)}}function E(i,d){if(1&i&&(t.j41(0,"div")(1,"h3",10),t.EFF(2),t.k0s(),t.j41(3,"ion-accordion-group"),t.DNE(4,R,10,2,"ion-accordion",11),t.k0s()()),2&i){const c=d.$implicit;t.R7$(2),t.JRh(c.format_date),t.R7$(2),t.Y8G("ngForOf",c.unities)}}const k=[{path:"",component:(()=>{var i;class d{constructor(n,o,s,e,a,r){this.sync=n,this.storage=o,this.utilsService=s,this.messages=e,this.router=a,this.route=r,this.contentDays=[],this.unities=[],this.lessonPlans=[],this.contentRecords=[],this.teachingPlans={unities:[]},this.classrooms=[],this.currentDate=new Date}ngOnInit(){var n=this;return(0,v.A)(function*(){yield n.sync.isSyncDelayed(),n.route.params.subscribe(()=>{n.contentDays=[],n.unities=[],n.lessonPlans=[],n.contentRecords=[],n.teachingPlans={unities:[]},n.classrooms=[],n.currentDate=new Date,n.loadContentDays()})})()}refreshPage(){this.loadContentDays()}loadContentDays(){(0,b.p)([this.storage.get("contentLessonPlans"),this.storage.get("contentRecords"),this.storage.get("teachingPlans"),this.storage.get("classrooms")]).subscribe(n=>{this.lessonPlans=n[0]||[],this.contentRecords=n[1]||[],this.teachingPlans=n[2]||{unities:[]},this.classrooms=n[3]||[];const o=this.contentDays.length;let s=0;for(;o>=this.contentDays.length&&s<10;){const e=this.loadLastSevenDays();if(e.length){this.contentDays=this.contentDays.concat(e);break}s+=1}})}loadLastSevenDays(){const o=[];for(let s=7;s>0;s--){let e=[],a=this.currentDate;a.setHours(0,0,0,0),this.contentRecords.forEach(r=>{let u=this.utilsService.getDate(r.record_date);if(u.setHours(24,0,0,0),a.getTime()!==u.getTime())return;let l=e.map(h=>h.id).indexOf(Number(r.unity_id));l<0&&(e.push({id:r.unity_id,name:r.unity_name,filledRecords:0,totalRecords:0,unityItems:[]}),l=e.length-1),e[l].filledRecords++,e[l].totalRecords++,e[l].unityItems.push({discipline_id:r.discipline_id,classroom_id:r.classroom_id,grade_id:r.grade_id,description:r.description,classroom_name:r.classroom_name,contents:r.contents,plannedContents:[],type:"contentRecord"})}),this.processLessonPlans(e,a),this.processTeachingPlans(e,a),this.calculateUniqueContents(e),e.length&&o.push({unities:e,date:this.utilsService.toStringWithoutTime(a),format_date:this.utilsService.toExtensiveFormat(a)}),this.currentDate.setDate(a.getDate()-1)}return o}processLessonPlans(n,o){(this.lessonPlans||[]).forEach(s=>{const e=this.utilsService.getDate(s.start_at),a=this.utilsService.getDate(s.end_at);if(e.setHours(24,0,0,0),a.setHours(24,0,0,0),o>=e&&o<=a){const r=n.map(u=>u.id).indexOf(s.unity_id);if(r>=0){const u=s.description+" - "+s.classroom_name,l=n[r].unityItems.map(h=>h.description+" - "+h.classroom_name).indexOf(u);l>=0&&(n[r].unityItems[l].plannedContents=n[r].unityItems[l].plannedContents.concat(s.contents))}}})}processTeachingPlans(n,o){(this.teachingPlans.unities||[]).forEach(s=>{const e=n.map(a=>parseInt(a.id)).indexOf(parseInt(s.unity_id));s.plans.forEach(a=>{e>=0&&this.getClassroomsByGradeAndUnity(this.classrooms,s.unity_id,a.grade_id).forEach(r=>{const u=a.description+" - "+r.description,l=n[e].unityItems.map(h=>h.description+" - "+h.classroom_name).indexOf(u);l>=0&&(!n[e].unityItems[l].plannedContents||!n[e].unityItems[l].plannedContents.length)&&(n[e].unityItems[l].plannedContents=n[e].unityItems[l].plannedContents.concat(a.contents))})})})}calculateUniqueContents(n){n.forEach((o,s)=>{n[s].situation_percentage=(o.filledRecords/o.totalRecords||0).toLocaleString(),o.unityItems.forEach((e,a)=>{const r=e.contents.concat(e.plannedContents).map(u=>u.id+"-"+u.description).filter((u,l,h)=>h.indexOf(u)===l);n[s].unityItems[a].uniqueContents=r})})}getClassroomsByGradeAndUnity(n,o,s){let e=[];return n.filter(a=>a.unityId===o).forEach(a=>{a.data.forEach(r=>{r.grade_id===s&&e.push(r)})}),e}newContentRecordForm(n,o){this.utilsService.hasAvailableStorage().then(s=>{s?this.storage.get("unities").then(e=>{this.router.navigate(["/new-content-record-form"],{queryParams:{unityId:o,date:n},state:{unities:e}})}):this.messages.showError(this.messages.insuficientStorageErrorMessage("lan\xe7ar novos registros de conte\xfado"))})}openContentRecordForm(n,o,s,e,a,r,u,l){this.router.navigate(["/content-record-form"],{queryParams:{date:n,unityId:o,disciplineId:s,classroomId:e,gradeId:a,description:r,classroomName:u,unityName:l}})}doRefresh(){this.sync.execute().subscribe({next:()=>this.loadContentDays()})}}return(i=d).\u0275fac=function(n){return new(n||i)(t.rXU(T.n),t.rXU(D.n),t.rXU(F.T),t.rXU(I.G),t.rXU(p.Ix),t.rXU(p.nX))},i.\u0275cmp=t.VBU({type:i,selectors:[["app-tab2"]],decls:15,vars:2,consts:[["mode","md"],["slot","end"],[3,"click"],["slot","icon-only","name","sync"],["slot","icon-only","name","add"],[1,"page-content"],["class","empty-results",4,"ngIf"],[4,"ngFor","ngForOf"],[1,"load-more"],[1,"empty-results"],[1,"date-header"],["class","panel",4,"ngFor","ngForOf"],[1,"panel"],["slot","header"],["slot","content"],["fill","clear","size","default",3,"click"],["slot","start","name","add-circle-outline"],[3,"click",4,"ngFor","ngForOf"]],template:function(n,o){1&n&&(t.j41(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),t.EFF(3,"Conte\xfados de aula"),t.k0s(),t.j41(4,"ion-buttons",1)(5,"ion-button",2),t.bIt("click",function(){return o.doRefresh()}),t.nrm(6,"ion-icon",3),t.k0s(),t.j41(7,"ion-button",2),t.bIt("click",function(){return o.newContentRecordForm()}),t.nrm(8,"ion-icon",4),t.k0s()()()(),t.j41(9,"ion-content",5),t.DNE(10,C,3,0,"div",6)(11,E,5,2,"div",7),t.j41(12,"div",8)(13,"ion-button",2),t.bIt("click",function(){return o.loadContentDays()}),t.EFF(14," Carregar mais conte\xfados "),t.k0s()()()),2&n&&(t.R7$(10),t.Y8G("ngIf",0===o.contentDays.length),t.R7$(),t.Y8G("ngForOf",o.contentDays))},dependencies:[g.xk,g.YH,g.In,g.Jm,g.QW,g.W9,g.eU,g.iq,g.uz,g.he,g.BC,g.ai,f.Sq,f.bT]}),d})()}];let j=(()=>{var i;class d{}return(i=d).\u0275fac=function(n){return new(n||i)},i.\u0275mod=t.$C({type:i}),i.\u0275inj=t.G2t({imports:[p.iI.forChild(k),p.iI]}),d})(),$=(()=>{var i;class d{}return(i=d).\u0275fac=function(n){return new(n||i)},i.\u0275mod=t.$C({type:i}),i.\u0275inj=t.G2t({imports:[g.bv,f.MD,_.YN,j]}),d})()}}]);